#!/usr/bin/env bash

NP=$1
name=$2

if [ "$NP" -gt @TESTS_NPROCS@ ];
then
    echo "skipping $NP processes"
    exit 77
fi

base=box

# The pgfem executable is built in the build directory.
pgfem=@abs_top_builddir@/src/PGFem3D

test_dir=@top_srcdir@/verification_tests/crystal_plasticity

# The input directory is specific to the number of processors in the domain
# decomposition. 
in_dir=@srcdir@/${base}_${NP}CPU_${name}

# The output directory is in the build tree and is specific to the number of
# processors in the domain.
out_dir=@builddir@/${name}/${base}_${NP}CPU

# The actual input and output arguments to PGFem3D follow a somewhat odd
# convention. 
input=${in_dir}/${base}_
output=${out_dir}/${base}

overrides="-override-solver-file ${test_dir}/${base}_0.in.st_${name}"
opts="-SS -cm 1 -noLS -noCCE -no-compute-macro -maxit 3000 -kdim 1000 -V"
cmd="mpirun -np $NP $pgfem $opts $overrides $input $output"
echo $cmd
$cmd
